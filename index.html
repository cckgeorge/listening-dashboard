<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è½ç‹æˆç¸¾åˆ†æ - ç´«è‰²ç™¾åˆ†æ¯”ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f1f5f9; }
        
        /* å¡ç‰‡è¨­è¨ˆ */
        .card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            padding: 0; 
            overflow: hidden; 
            margin-bottom: 1.5rem; 
            break-inside: avoid;   
        }
        
        .btn { cursor: pointer; transition: 0.2s; user-select: none; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background-color: #f8fafc; color: #64748b; font-weight: bold; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #334155; vertical-align: middle; font-size: 1rem; }
        tr:last-child td { border-bottom: none; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 0.85rem; font-weight: 700; display: inline-block; }
        .status-done { background-color: #dcfce7; color: #166534; } 
        .status-low { background-color: #f3e8ff; color: #6b21a8; } /* æ”¹ç‚ºç´«è‰²ç³» */
        .status-pending { background-color: #fef9c3; color: #a16207; } 
        .status-alert { background-color: #fee2e2; color: #b91c1c; } 
        .score-perfect { color: #ea580c; font-weight: 800; }
        .text-warn { color: #dc2626; font-weight: 800; }

        @media (max-width: 768px) {
            thead { display: none; }
            tbody tr { display: block; border-bottom: 1px solid #e2e8f0; padding: 12px; }
            td { display: flex; justify-content: space-between; align-items: center; border-bottom: none; padding: 6px 0; }
            td::before { content: attr(data-label); font-weight: bold; color: #94a3b8; font-size: 0.9rem; }
            .text-2xl { font-size: 1.25rem; } 
        }
        
        /* æ™‚é–“æ¨™ç±¤ */
        .timestamp-badge { 
            background-color: #fff; 
            color: #475569; 
            padding: 6px 12px; 
            border-radius: 6px; 
            font-family: monospace; 
            font-size: 1rem; 
            font-weight: bold; 
            display: inline-block; 
            margin-top: 8px; 
            border: 1px solid #cbd5e1; 
        }
        
        .input-control { border: 2px solid #3b82f6; color: #1e40af; padding: 10px 16px; border-radius: 8px; font-weight: bold; outline: none; }
        .class-select {
            appearance: none; cursor: pointer; padding-right: 32px;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%231e40af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }

        .chart-container { position: relative; height: 320px; width: 100%; display: flex; justify-content: center; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-6xl mx-auto" id="captureArea">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <h1 id="mainTitle" class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight mb-3">è‹±è½ç‹æˆç¸¾åˆ†æ ğŸ“Š</h1>
            <div id="analysisTimeDisplay" class="hidden">
                <span class="timestamp-badge">çµ±è¨ˆæ™‚é–“ï¼šå°šæœªåŒ¯å…¥</span>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-2 w-full md:w-auto items-center" data-html2canvas-ignore="true">
            <select id="classSelect" onchange="updateClassInfo()" class="input-control class-select shadow w-28">
                <option value="" disabled selected>é¸ç­ç´š</option>
                <optgroup label="ä¸‰å¹´ç´š"> <option value="3A">3A</option><option value="3B">3B</option><option value="3C">3C</option> </optgroup>
                <optgroup label="å››å¹´ç´š"> <option value="4A">4A</option><option value="4B">4B</option><option value="4C">4C</option> </optgroup>
                <optgroup label="äº”å¹´ç´š"> <option value="5A">5A</option><option value="5B">5B</option><option value="5C">5C</option> </optgroup>
                <optgroup label="å…­å¹´ç´š"> <option value="6A">6A</option><option value="6B">6B</option><option value="6C">6C</option> </optgroup>
            </select>
            <input type="text" id="customClassInput" placeholder="æˆ–æ‰‹å‹•è¼¸å…¥" oninput="updateClassInfo()" class="input-control shadow w-32">
            <label class="btn bg-blue-600 text-white px-4 py-3 rounded-lg shadow flex-1 md:flex-none text-center block">
                <span>ğŸ“‚ åŒ¯å…¥</span>
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" class="hidden">
            </label>
            <button onclick="copyToClipboard()" class="btn bg-emerald-600 text-white px-4 py-3 rounded-lg shadow flex-1 md:flex-none">
                ğŸ“‹ è¤‡è£½
            </button>
            <button onclick="takeScreenshot(this)" class="btn bg-indigo-600 text-white px-4 py-3 rounded-lg shadow flex-1 md:flex-none">
                ğŸ“· æˆªåœ–
            </button>
        </div>
    </div>

    <div class="bg-gradient-to-r from-orange-100 to-amber-100 border-l-4 border-orange-500 p-4 rounded-r shadow-sm mb-6 flex items-start gap-3">
        <div class="text-3xl">ğŸ</div>
        <div>
            <h3 class="font-bold text-orange-800 text-lg">æ»¿åˆ†çå‹µå…¬å‘Š</h3>
            <p class="text-orange-900 font-medium text-sm md:text-base">
                å®Œæˆæ¯”è³½ä¸¦é”åˆ°æ»¿åˆ†çš„åŒå­¸ï¼Œå¯ä»¥å¾—åˆ°åœ‹æ•™ç½²çš„çç‹€ï¼Œæ›´èƒ½æŠ½ç <span class="text-red-600 font-bold text-lg bg-white px-1 rounded">600 å…ƒ</span> ç¦®åˆ¸å”·ï¼
            </p>
        </div>
    </div>

    <div id="dashboard" class="hidden mb-8">
        <div class="grid grid-cols-2 gap-6 mb-6">
            
            <div class="card p-6 border-t-4 border-blue-500 flex flex-col items-center justify-center shadow-lg">
                <div class="text-slate-500 text-lg font-bold tracking-wider mb-2">å…¨ç­äººæ•¸ / å®Œæˆç‡</div>
                <div class="flex flex-col items-center gap-1">
                    <span class="text-6xl font-extrabold text-slate-800 leading-none" id="stat-total">0</span>
                    <span class="text-2xl font-bold text-blue-700 bg-blue-100 px-4 py-1 rounded-full mt-3" id="stat-rate">0%</span>
                </div>
            </div>

            <div class="card p-6 border-t-4 border-red-500 bg-red-50 flex flex-col items-center justify-center shadow-lg">
                <div class="text-red-700 text-lg font-bold tracking-wider mb-2">æœªå®Œæˆ / è½å¾Œ</div>
                <div class="text-6xl font-extrabold text-red-600" id="stat-incomplete">0</div>
            </div>

            <div class="card p-6 border-t-4 border-purple-500 bg-purple-50 flex flex-col items-center justify-center shadow-lg">
                <div class="text-purple-700 text-lg font-bold tracking-wider mb-2">å®Œæˆä½†ä½åˆ†</div>
                <div class="text-6xl font-extrabold text-purple-600" id="stat-low">0</div>
            </div>

            <div class="card p-6 border-t-4 border-green-500 flex flex-col items-center justify-center shadow-lg">
                <div class="text-slate-500 text-lg font-bold tracking-wider mb-2">åˆæ ¼äººæ•¸ (å«æ»¿åˆ†)</div>
                <div class="text-6xl font-extrabold text-green-600" id="stat-ok">0</div>
            </div>
        </div>

        <div class="card p-6 border-t-4 border-indigo-500 flex flex-col md:flex-row items-center justify-center gap-8 shadow-lg">
            <div class="w-full md:w-1/3 flex flex-col justify-center items-center">
                <h3 class="font-bold text-slate-700 mb-4 text-xl">ğŸ“Š ç­ç´šæˆç¸¾åˆ†å¸ƒåœ–</h3>
                <div class="chart-container">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            <div class="w-full md:w-2/3 text-slate-700 text-base leading-loose px-2 md:px-4 mt-4 md:mt-0">
                <p class="font-bold text-xl mb-3 border-b pb-2">ğŸ’¡ åˆ¤è®€èªªæ˜ï¼š</p>
                <ul class="space-y-3">
                    <li><span class="text-orange-500 font-bold text-lg">â— æ©˜è‰²</span>ï¼šæ»¿åˆ† (å¤ªå¼·äº†ï¼)</li>
                    <li><span class="text-green-600 font-bold text-lg">â— ç¶ è‰²</span>ï¼šå·²å®Œæˆä¸”åˆæ ¼ (å¾ˆæ£’ï¼)</li>
                    <li><span class="text-purple-600 font-bold text-lg">â— ç´«è‰²</span>ï¼šå·²å®Œæˆä½†åˆ†æ•¸åä½ (éœ€å†åŠ æ²¹)</li>
                    <li><span class="text-yellow-600 font-bold text-lg">â— é»ƒè‰²</span>ï¼šé€²è¡Œä¸­ (é‚„åœ¨åŠªåŠ›)</li>
                    <li><span class="text-red-600 font-bold text-lg">â— ç´…è‰²</span>ï¼šå°šæœªé–‹å§‹ (éœ€è¦æé†’)</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="resultArea" class="hidden columns-1 md:columns-2 gap-6 space-y-0"></div>

    <script>
        Chart.register(ChartDataLabels);

        let globalReportText = "";
        let currentAnalysisTimeStr = "";
        let currentJsonData = null;
        let myPieChart = null;

        const CATEGORY_CONFIG = {
            urgent: { 
                title: "ğŸš¨ å„ªå…ˆè¿½è¹¤ (å°šæœªé–‹å§‹)", 
                borderColor: "border-red-500", headerBg: "bg-red-50", headerBorder: "border-red-100", titleColor: "text-red-800", countBg: "bg-red-200",
                headers: `<tr><th class="w-16">åº§è™Ÿ</th><th>å§“å</th><th>é€²åº¦</th><th>ç‹€æ…‹</th></tr>`
            },
            low: { 
                // æ”¹ç´«è‰²ç³»
                title: "ğŸ˜Ÿ å®Œæˆä½†åˆ†æ•¸åä½ (éœ€å†åŠ æ²¹)", 
                borderColor: "border-purple-500", headerBg: "bg-purple-50", headerBorder: "border-purple-100", titleColor: "text-purple-800", countBg: "bg-purple-200",
                headers: `<tr><th class="w-16">åº§è™Ÿ</th><th>å§“å</th><th>åˆ†æ•¸</th><th>å¹³å‡</th></tr>`
            },
            progress: { 
                title: "â³ åŠ æ²¹å€ (é€²è¡Œä¸­)", 
                borderColor: "border-yellow-500", headerBg: "bg-yellow-50", headerBorder: "border-yellow-100", titleColor: "text-yellow-800", countBg: "bg-yellow-200",
                headers: `<tr><th class="w-16">åº§è™Ÿ</th><th>å§“å</th><th>é€²åº¦</th><th>å¹³å‡</th></tr>`
            },
            honor: { 
                title: "ğŸ† 4000åˆ†æ¦®è­½æ¦œ", 
                borderColor: "border-orange-500", headerBg: "bg-orange-50", headerBorder: "border-orange-100", titleColor: "text-orange-800", countBg: "bg-orange-200",
                headers: `<tr><th class="w-16">åº§è™Ÿ</th><th>å§“å</th><th>åˆ†æ•¸</th><th>ç‹€æ…‹</th></tr>`
            },
            pass: { 
                title: "âœ… å·²å®Œæˆ (æ‹š100å¯å¾—ç)", 
                borderColor: "border-green-500", headerBg: "bg-green-50", headerBorder: "border-green-100", titleColor: "text-green-800", countBg: "bg-green-200",
                headers: `<tr><th class="w-16">åº§è™Ÿ</th><th>å§“å</th><th>åˆ†æ•¸</th><th>å¹³å‡</th></tr>`
            }
        };

        document.getElementById('fileInput').addEventListener('change', handleFile);

        function maskName(name) {
            name = name.replace(/\s+/g, '');
            if (!name || name.length < 2) return name;
            let chars = name.split('');
            chars[1] = 'O';
            return chars.join('');
        }

        function updateClassInfo() {
            if (currentJsonData) {
                processData(currentJsonData); 
            } else {
                const manualVal = document.getElementById('customClassInput').value.trim();
                const dropdownVal = document.getElementById('classSelect').value;
                const finalClass = manualVal || dropdownVal;
                document.getElementById('mainTitle').innerText = finalClass ? `${finalClass} è‹±è½ç‹æˆç¸¾åˆ†æ ğŸ“Š` : 'è‹±è½ç‹æˆç¸¾åˆ†æ ğŸ“Š';
            }
        }

        function handleFile(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                currentJsonData = XLSX.utils.sheet_to_json(firstSheet);
                processData(currentJsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            const now = new Date();
            const displayTime = now.toLocaleString('zh-TW', { hour12: false, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
            
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            currentAnalysisTimeStr = `${year}${month}${day}_${hour}${minute}`;

            const manualVal = document.getElementById('customClassInput').value.trim();
            const dropdownVal = document.getElementById('classSelect').value;
            const finalClass = manualVal || dropdownVal || "";
            const titlePrefix = finalClass ? finalClass + " " : "";

            document.getElementById('mainTitle').innerText = `${titlePrefix}è‹±è½ç‹æˆç¸¾åˆ†æ ğŸ“Š`;
            document.getElementById('analysisTimeDisplay').innerHTML = `<span class="timestamp-badge">çµ±è¨ˆæ™‚é–“ï¼š${displayTime}</span>`;
            document.getElementById('analysisTimeDisplay').classList.remove('hidden');

            let rowsData = { urgent: [], low: [], progress: [], honor: [], pass: [] };
            let textData = { urgent: [], low: [], progress: [], honor: [], pass: [] };
            let stats = { total: 0, ok: 0, low: 0, incomplete: 0 };
            let chartData = { honor: 0, pass: 0, low: 0, progress: 0, urgent: 0 };

            data.forEach(row => {
                let rawName = row['å§“å'] || row['Name'] || 'æœªçŸ¥';
                const name = maskName(rawName);
                const seat = row['åº§è™Ÿ'] || row['Seat'] || '?';
                const status = (row['ä½œç­”ç‹€æ³'] || row['Status'] || '').trim();
                const prog = row['ä½œç­”/ç¸½é¡Œçµ„æ•¸'] || row['Progress'] || '0 / 0';
                const totalScore = parseFloat(row['ç¸½åˆ†']) || 0;
                const avg = parseFloat(row['å¹³å‡']) || 0;

                stats.total++;

                if (status === 'å®Œæˆ') {
                    if (totalScore === 4000) {
                        stats.ok++;
                        chartData.honor++;
                        rowsData.honor.push(`
                            <td data-label="åº§è™Ÿ" class="font-bold text-blue-600">${seat}</td>
                            <td data-label="å§“å" class="font-bold">${name}</td>
                            <td data-label="åˆ†æ•¸" class="score-perfect text-xl">${totalScore}</td>
                            <td data-label="ç‹€æ…‹"><span class="status-badge status-done">æ»¿åˆ†</span></td>
                        `);
                        textData.honor.push(`${seat}è™Ÿ ${name}`);
                    } else if (avg < 70) {
                        stats.low++;
                        chartData.low++;
                        rowsData.low.push(`
                            <td data-label="åº§è™Ÿ" class="font-bold text-blue-600">${seat}</td>
                            <td data-label="å§“å" class="font-bold">${name}</td>
                            <td data-label="åˆ†æ•¸" class="text-purple-600 font-bold">${totalScore}</td>
                            <td data-label="å¹³å‡" class="text-gray-500">${avg}</td>
                        `);
                        textData.low.push(`${seat}è™Ÿ ${name} (å‡${avg})`);
                    } else {
                        stats.ok++;
                        chartData.pass++;
                        rowsData.pass.push(`
                            <td data-label="åº§è™Ÿ" class="font-bold text-blue-600">${seat}</td>
                            <td data-label="å§“å" class="font-bold">${name}</td>
                            <td data-label="åˆ†æ•¸">${totalScore}</td>
                            <td data-label="å¹³å‡" class="text-gray-500">${avg}</td>
                        `);
                        textData.pass.push(`${seat}è™Ÿ${name}(${totalScore})`);
                    }
                } else {
                    stats.incomplete++;
                    if (prog.startsWith('0 /') || prog === '0') {
                        chartData.urgent++;
                        rowsData.urgent.push(`
                            <td data-label="åº§è™Ÿ" class="font-bold text-blue-600">${seat}</td>
                            <td data-label="å§“å" class="font-bold">${name}</td>
                            <td data-label="é€²åº¦" class="text-red-600 font-bold">${prog}</td>
                            <td data-label="ç‹€æ…‹"><span class="status-badge status-alert">æœªå‹•</span></td>
                        `);
                        textData.urgent.push(`[æœªåš] ${seat}è™Ÿ ${name}`);
                    } else {
                        chartData.progress++;
                        let avgDisplay = avg < 70 
                            ? `<span class="text-warn">âš ï¸ ${avg}</span>` 
                            : `<span class="text-gray-500">${avg}</span>`;
                        rowsData.progress.push(`
                            <td data-label="åº§è™Ÿ" class="font-bold text-blue-600">${seat}</td>
                            <td data-label="å§“å" class="font-bold">${name}</td>
                            <td data-label="é€²åº¦" class="text-yellow-700 font-bold">${prog}</td>
                            <td data-label="å¹³å‡">${avgDisplay}</td>
                        `);
                        let reportNote = `[${prog}]`;
                        if(avg < 70) reportNote += `(âš ï¸å‡${avg})`;
                        textData.progress.push(`${seat}è™Ÿ ${name} ${reportNote}`);
                    }
                }
            });

            document.getElementById('stat-total').innerText = stats.total;
            const completionRate = stats.total > 0 ? Math.round((stats.ok + stats.low) / stats.total * 100) : 0;
            document.getElementById('stat-rate').innerText = completionRate + "%";
            document.getElementById('stat-ok').innerText = stats.ok;
            document.getElementById('stat-low').innerText = stats.low;
            document.getElementById('stat-incomplete').innerText = stats.incomplete;
            document.getElementById('dashboard').classList.remove('hidden');

            const resultArea = document.getElementById('resultArea');
            resultArea.innerHTML = ""; 
            resultArea.classList.remove('hidden');

            renderSmartCard(resultArea, 'urgent', rowsData.urgent);
            renderSmartCard(resultArea, 'low', rowsData.low);
            renderSmartCard(resultArea, 'progress', rowsData.progress);
            renderSmartCard(resultArea, 'honor', rowsData.honor);
            renderSmartCard(resultArea, 'pass', rowsData.pass);

            updateChart(chartData);

            const reportHeader = finalClass ? `ã€${finalClass} è‹±è½ç‹é€²åº¦å ±å‘Šã€‘` : `ã€è‹±è½ç‹é€²åº¦å ±å‘Šã€‘`;
            globalReportText = `${reportHeader}\r\nçµ±è¨ˆæ™‚é–“ï¼š${displayTime}\r\nğŸ æ»¿åˆ†åŒå­¸å¯æŠ½ 600 å…ƒç¦®åˆ¸ï¼\r\n\r\nğŸš¨ å„ªå…ˆè¿½è¹¤ (0é€²åº¦)ï¼š\r\n${textData.urgent.length ? textData.urgent.join('\n') : '(ç„¡)'}\r\n\r\nğŸ˜Ÿ å®Œæˆä½†åˆ†æ•¸åä½ (éœ€å†åŠ æ²¹)ï¼š\r\n${textData.low.length ? textData.low.join('\n') : '(ç„¡)'}\r\n\r\nâ³ åŠ æ²¹å€ (é€²è¡Œä¸­)ï¼š\r\n${textData.progress.length ? textData.progress.join('\n') : '(ç„¡)'}\r\n\r\nâœ… å·²å®Œæˆ (åŠªåŠ›æ‹š100å¯å¾—ç)ï¼š\r\n${textData.pass.length ? textData.pass.join('ã€') : '(ç„¡)'}\r\n\r\nğŸ† 4000åˆ†æ»¿åˆ†æ¦®è­½æ¦œï¼š\r\n${textData.honor.length ? textData.honor.join('ã€') : '(ç„¡)'}`;
        }

        function renderSmartCard(container, type, rows) {
            const config = CATEGORY_CONFIG[type];
            const totalItems = rows.length;

            if (totalItems === 0) {
                if(type === 'low' || type === 'urgent') return;
                const html = `
                    <div class="card border-t-4 ${config.borderColor}">
                        <div class="${config.headerBg} px-5 py-4 border-b ${config.headerBorder} flex justify-between items-center">
                            <h2 class="font-bold flex items-center gap-2 text-lg ${config.titleColor}">${config.title}</h2>
                            <span class="text-sm ${config.countBg} ${config.titleColor} px-3 py-1 rounded-full font-bold">0</span>
                        </div>
                        <div class="p-4 text-center text-gray-400 text-sm">ç„¡</div>
                    </div>`;
                container.innerHTML += html;
                return;
            }

            const threshold = 15;
            let splitSize = threshold;
            
            if (totalItems > threshold) {
                splitSize = Math.ceil(totalItems / 2);
            }

            for (let i = 0; i < totalItems; i += splitSize) {
                const chunk = rows.slice(i, i + splitSize);
                const isSplit = totalItems > splitSize;
                const partLabel = isSplit ? ` (${Math.floor(i/splitSize) + 1}/${Math.ceil(totalItems/splitSize)})` : "";
                
                let rowsHtml = "";
                chunk.forEach(r => rowsHtml += `<tr>${r}</tr>`);

                const html = `
                    <div class="card border-t-4 ${config.borderColor}">
                        <div class="${config.headerBg} px-5 py-4 border-b ${config.headerBorder} flex justify-between items-center">
                            <h2 class="font-bold flex items-center gap-2 text-lg ${config.titleColor}">${config.title}${partLabel}</h2>
                            <span class="text-sm ${config.countBg} ${config.titleColor} px-3 py-1 rounded-full font-bold">${totalItems}</span>
                        </div>
                        <table>
                            <thead class="${config.headerBg}/50">${config.headers}</thead>
                            <tbody>${rowsHtml}</tbody>
                        </table>
                    </div>`;
                container.innerHTML += html;
            }
        }

        function updateChart(data) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if (myPieChart) myPieChart.destroy();

            myPieChart = new Chart(ctx, {
                type: 'doughnut', 
                data: {
                    labels: ['æ»¿åˆ†æ¦®è­½', 'å·²å®Œæˆ', 'å®Œæˆ(éœ€å†åŠ æ²¹)', 'é€²è¡Œä¸­', 'å°šæœªé–‹å§‹'],
                    datasets: [{
                        data: [data.honor, data.pass, data.low, data.progress, data.urgent],
                        // æ”¹ç´«è‰²ç³» (#a855f7)
                        backgroundColor: ['#f97316', '#22c55e', '#a855f7', '#eab308', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 16 }, 
                            // ä¿®æ”¹é»ï¼šè¨ˆç®—ç™¾åˆ†æ¯”
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => {
                                    sum += data;
                                });
                                // é¿å…é™¤ä»¥ 0
                                if (sum === 0) return "";
                                let percentage = (value * 100 / sum).toFixed(0) + "%";
                                return value > 0 ? percentage : '';
                            }
                        }
                    },
                    layout: { padding: 10 }
                }
            });
        }

        function copyToClipboard() {
            if(!globalReportText) return alert("è«‹å…ˆåŒ¯å…¥æª”æ¡ˆï¼");
            navigator.clipboard.writeText(globalReportText).then(() => alert('å ±å‘Šå·²è¤‡è£½ï¼'));
        }

        function takeScreenshot(btnElement) {
            if(!globalReportText) return alert("è«‹å…ˆåŒ¯å…¥æª”æ¡ˆï¼");
            const btn = btnElement || window.event.target; 
            const originalText = btn.innerText;
            btn.innerText = "â³ è™•ç†ä¸­...";
            btn.disabled = true;
            
            const target = document.getElementById('captureArea');
            const manualVal = document.getElementById('customClassInput').value.trim();
            const dropdownVal = document.getElementById('classSelect').value;
            const finalClass = manualVal || dropdownVal || "All";

            html2canvas(target, {
                scale: 2, 
                backgroundColor: "#f1f5f9",
                useCORS: true, 
                scrollY: -window.scrollY, 
                windowWidth: document.documentElement.scrollWidth,
                height: target.scrollHeight,
                windowHeight: target.scrollHeight
            }).then(canvas => {
                btn.innerText = originalText;
                btn.disabled = false;
                const link = document.createElement('a');
                link.download = `${finalClass}_è‹±è½ç‹æˆç¸¾å ±å‘Š_${currentAnalysisTimeStr || 'result'}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }).catch(err => {
                console.error(err);
                alert("æˆªåœ–å¤±æ•—");
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>